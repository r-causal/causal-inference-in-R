{
  "hash": "6698a250012313364b9c74e5e2103d1b",
  "result": {
    "markdown": "# Estimating counterfactuals {#sec-counterfactuals}\n\n\n\n\n\n## Potential Outcomes {#sec-potential}\n\nLet's begin by thinking about the philosophical concept of a *potential outcome.* Prior to some \"cause\" occurring, for example receiving some exposure, the *potential outcomes* are all of the potential things that could occur depending on what you end up exposed to.\nFor simplicity, let's assume an exposure has two levels:\n\n-   $X=1$ if you are exposed\n\n-   $X=0$ if you are not exposed\n\nUnder this simple scenario, there are two potential outcomes:\n\n-   $Y(1)$ the potential outcome if you are exposed\n\n-   $Y(0)$ the potential outcome if you are not exposed\n\nOnly *one* of these potential outcomes will actually be realized, the one corresponding to the exposure that actually occurred, and therefore only one is observable.\nIt is important to remember here that these exposures are defined at a particular instance in time, so only one can happen to any individual.\nIn the case of a binary exposure, this leaves one potential outcome as *observable* and one *missing.* In fact, early causal inference methods were often framed as missing data problems; we need to make certain assumptions about the *missing counterfactuals*, the value of the potential outcome corresponding to the exposure(s) that did not occur.\n\nOur causal effect of interest is often some difference in potential outcomes $Y(1) - Y(0)$, averaged over a particular population.\n\n## Counterfactuals\n\nConceptually, the missing counterfactual outcome is one that would have occurred under a different set of circumstances.\nIn causal inference, we *wish* we could observe the conterfactual outcome that would have occurred in an alternate universe where the exposure status for a given observation was flipped.\nTo do this, we attempt to control for all factors that are related to an exposure and outcome such that we can *construct* (or estimate) such a counterfactual outcome.\n\nLet's think about a specific example.\nIce-T, best known as an American rapper and Fin on Law and Order: SVU, co-authored a book titled \"Split Decision: Life Stories\", published in 2022.\nHere is the synopsis:\n\n> **Award-winning actor, rapper, and producer Ice-T unveils a compelling memoir of his early life robbing jewelry stores until he found fame and fortune---while a handful of bad choices sent his former crime partner down an incredibly different path.**\\\n> \\\n> Ice-T rose to fame in the late 1980s, earning acclaim for his music before going on to enthrall television audiences as Odafin \"Fin\" Tutuola in *Law & Order: Special Victims Unit*.\n> But it could have gone much differently.\\\n>\n> \\\n> In this \"poignant and powerful\" (*Library Journal*, starred review) memoir, Ice-T and Spike, his former crime partner---collaborating with *New York Times* bestselling author Douglas Century---relate the shocking stories of their shared pasts, and how just a handful of decisions led to their incredibly different lives.\n> Both grew up in violent, gang-controlled Los Angeles neighborhoods and worked together to orchestrate a series of jewelry heists.\\\n>\n> \\\n> But while Ice-T was discovered rapping in a club and got his first record deal, Spike was caught for a jewelry robbery and did three years in prison.\n> As his music career began to take off, Ice made the decision to abandon the criminal life; Spike continued to plan increasingly ingenious and risky jewel heists.\n> And in 1992, after one of Spike's robberies ended tragically, he was sentenced to thirty-five years to life.\n> While he sat behind bars, he watched his former partner rise to fame in music, movies, and television.\\\n>\n> \\\n> \"Propulsive\" (*Publishers Weekly*, starred review), timely, and thoughtful, two men with two very different lives reveal how their paths might have very well been reversed if they made different choices.\n> All it took was a *split decision*.\n> [@split]\n\nThis premise is compelling because it implies that we are observing a *counterfactual*.\nThe book begins by setting up all the ways Ice-T and his friend Spike were similar prior to some important moment (both grew up in Los Angeles neighborhoods, both were involved with gangs, both worked together to orchestrate a series of jewelry heists, etc).\nThen something happens -- Ice-T makes a decision to abandon criminal life and Spike makes the opposite decision.\nWhat happens next for Ice-T includes fame and fortune, while Spike ends up with 35 years to life in prison.\nThis book is attempting a small study, two people who prior to some event were the same and after were different -- Spike's outcomes serve as the counterfactual to Ice-T's.\n\n::: {#tbl-causal-map layout-ncol=\"1\"}\n\n```{mermaid}\n%%| echo: false\nflowchart LR\nA{Ice-T} --> |observed| B(Abandons criminal life)\nA -.-> |missing counterfactual| C(Does one more heist)\nC -.-> D[35 years in prison]\nB --> E[Fame & Fortune]\n\nclassDef grey fill:#ddd\nclass D,C grey\n```\n\n```{mermaid}\n%%| echo: false\nflowchart LR\nA{Spike} -.-> |missing counterfactual| B(Abandons criminal life)\nA --> |observed| C(Does one more heist)\nC --> D[35 years in prison]\nB -.-> E[Fame & Fortune]\nclassDef grey fill:#ddd\nclass E,B grey\n```\n\n\nIce-T and Spike Causal Map\n:::\n\nIn practice, this is what we attempt to do with causal inference techniques.\nEven randomized trials are limited to a single factual world, so we compare the average effects of groups with different exposures.\nNow, having this as a concrete example of an attempt to construct a counterfactual scenario in the \"real-world\" there are several issues that we can immediately see, highlighting the difficulty in drawing such inference.\nFirst, while the synopsis implies that the two individuals were similar prior to the precipitating event that dictated their future opposite directions, we can easily identify factors in which perhaps they differed.\nIce-T decided to leave his life of crime, but that wasn't the only factor in his success: he had enough musical talent to make a career of it.\nDid Spike have Ice-T's musical talent?\nCan we really conclude that his life would have turned out exactly like Ice-T's if he had made the exact same choices as Ice-T?\nIf we want to truly estimate the causal effect of the decision to leave criminal life on Ice-T's future outcomes, we would need to observe his ultimate course both under making the decision and not.\nOf course this is not possible, so what can we do?\nPerhaps we can find someone else who is exactly like Ice-T who did not make the same decision and see how they fare.\nOf course, Ice-T is unique, it would be challenging to find someone exactly like him.\nAgain, this is attempted with Spike, and even so presents challenges.\nOften, instead of relying on a single individual, we rely on many individuals.\nWe could conduct an experiment where we *randomize* many individuals to leave criminal life (or not) and see how this impacts their outcomes *on average* (this randomized trial seems to present some ethical issues, perhaps we need to look to *observational* studies to help answer this question).\nIn any case, we must rely on statistical techniques to help construct these unobservable counterfactuals.\n\n### Potential Outcomes Simulation {#sec-po-sim}\n\nLet's suppose some happiness index, from 1-10 exists.\nWe are interested in assessing whether eating chocolate ice cream versus vanilla will increase happiness.\nWe have 10 individuals with two potential outcomes for each, one is what their happiness would be if they ate chocolate ice cream, (defined as `y_chocolate` in the code below), and one is what their happiness would be if they ate vanilla ice cream (defined as `y_vanilla` in the code below). We can define the true causal effect of eating chocolate ice cream (versus vanilla) on happiness for each individual as the difference between the two (@tbl-po).\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- data.frame(\n  id = 1:10,\n  y_chocolate = c(4, 4, 6, 5, 6, 5, 6, 7, 5, 6),\n  y_vanilla = c(1, 3, 4, 5, 5, 6, 8, 6, 3, 5)\n) \n\ndata <- data |>\n  mutate(causal_effect = y_chocolate - y_vanilla)\n\ndata\n```\n:::\n\n::: {#tbl-po .cell tbl-cap='Potential Outcomes Simulation: The causal effect of eating chocolate (versus vanilla) ice cream on happiness'}\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n<tr>\n<th style=\"empty-cells: hide;border-bottom:hidden;\" colspan=\"1\"></th>\n<th style=\"border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; \" colspan=\"2\"><div style=\"border-bottom: 1px solid #ddd; padding-bottom: 5px; \">Potential Outcomes</div></th>\n<th style=\"border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; \" colspan=\"1\"><div style=\"border-bottom: 1px solid #ddd; padding-bottom: 5px; \">Causal Effect</div></th>\n</tr>\n  <tr>\n   <th style=\"text-align:right;\"> id </th>\n   <th style=\"text-align:right;\"> $$Y_i(\\textrm{chocolate})$$ </th>\n   <th style=\"text-align:right;\"> $$Y_i(\\textrm{vanilla})$$ </th>\n   <th style=\"text-align:right;\"> $$Y_i(\\textrm{chocolate}) - Y_i(\\textrm{vanilla})$$ </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 3 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:right;\"> -1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:right;\"> -2 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 9 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 10 </td>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata |>\n  summarize(\n    avg_chocolate = mean(y_chocolate),\n    avg_vanilla = mean(y_vanilla),\n    avg_causal_effect = mean(causal_effect)\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  avg_chocolate avg_vanilla avg_causal_effect\n1           5.4         4.6               0.8\n```\n\n\n:::\n:::\n\n\nFor example, examining @tbl-po, the causal effect of eating chocolate ice cream (versus vanilla) for individual `4` is 0, whereas the causal effect for individual `9` is 2. The *average* potential happiness after eating chocolate is 5.4 and the *average* potential happiness after eating vanilla is 4.6. The *average* treatment effect of eating chocolate (versus vanilla) ice cream among the five individuals in this study is 0.8. \n\nIn reality, we cannot observe both potential outcomes, in any moment in time, each individual in our study can only eat *one* flavor of ice cream. Suppose we let our participants choose which ice cream they wanted to eat and each choose their favorite (i.e. they knew which would make them \"happier\" and picked that one. Now what we *observe* is shown in @tbl-obs.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_observed <- data |>\n  mutate(\n    exposure = case_when(\n      # people who like chocolate more chose that\n      y_chocolate > y_vanilla ~ \"chocolate\",\n      # people who like vanilla more chose that\n      y_vanilla >= y_chocolate ~ \"vanilla\"\n    ),\n    observed_outcome = case_when(\n      exposure == \"chocolate\" ~ y_chocolate,\n      exposure == \"vanilla\" ~ y_vanilla\n    )\n  ) |>\n  # we can only observe the exposure and one potential outcome\n  select(id, exposure, observed_outcome)\ndata_observed\n```\n:::\n\n::: {#tbl-obs .cell tbl-cap='Potential Outcomes Simulation: The observed exposure and outcome used to estimate the effect of eating chocolate (versus vanilla) ice cream on happiness'}\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n<tr>\n<th style=\"empty-cells: hide;border-bottom:hidden;\" colspan=\"1\"></th>\n<th style=\"border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; \" colspan=\"1\"><div style=\"border-bottom: 1px solid #ddd; padding-bottom: 5px; \">Exposure</div></th>\n<th style=\"border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; \" colspan=\"1\"><div style=\"border-bottom: 1px solid #ddd; padding-bottom: 5px; \">Observed Outcome</div></th>\n</tr>\n  <tr>\n   <th style=\"text-align:right;\"> id </th>\n   <th style=\"text-align:left;\"> $$X_i$$ </th>\n   <th style=\"text-align:right;\"> $$Y_i$$ </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> chocolate </td>\n   <td style=\"text-align:right;\"> 4 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> chocolate </td>\n   <td style=\"text-align:right;\"> 4 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> chocolate </td>\n   <td style=\"text-align:right;\"> 6 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:left;\"> vanilla </td>\n   <td style=\"text-align:right;\"> 5 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:left;\"> chocolate </td>\n   <td style=\"text-align:right;\"> 6 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:left;\"> vanilla </td>\n   <td style=\"text-align:right;\"> 6 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:left;\"> vanilla </td>\n   <td style=\"text-align:right;\"> 8 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:left;\"> chocolate </td>\n   <td style=\"text-align:right;\"> 7 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 9 </td>\n   <td style=\"text-align:left;\"> chocolate </td>\n   <td style=\"text-align:right;\"> 5 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 10 </td>\n   <td style=\"text-align:left;\"> chocolate </td>\n   <td style=\"text-align:right;\"> 6 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_observed |>\n  group_by(exposure) |>\n  summarise(avg_outcome = mean(observed_outcome))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 2\n  exposure  avg_outcome\n  <chr>           <dbl>\n1 chocolate        5.43\n2 vanilla          6.33\n```\n\n\n:::\n:::\n\n\nNow, the *observed* average outcome among those who ate chocolate ice cream is 5.4 (the same as the true average potential outcome), while the *observed* average outcome among those who ate vanilla is 6.3 -- quite different from the *actual* average (4.6). The estimated causal effect here could be calculated as 5.4 - 6.3 = -0.9. \n\nIt turns out here, these 10 participants *chose* which ice cream they wanted to eat and they always chose to eat their favorite! This artificially made it look like eating vanilla ice cream would increase the happiness in this population when in fact we know the opposite is true. The next section will discuss which assumptions need to be true in order to allow us to *accurately* estimate causal effects using observed data. As a sneak peak, our issue here was that how the exposure was decided, if instead we *randomized* who ate chocolate versus vanilla ice cream we would (on average, with a large enough sample) recover the true causal effect.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## we are doing something *random* so let's set a seed so we always observe the\n## same result each time we run the code\nset.seed(11)\ndata_observed <- data |>\n  mutate(\n    # change the exposure to randomized, generate from a binomial distribution\n    # with a probability 0.5 for being in either group \n    exposure = case_when(\n      rbinom(10, 1, 0.5) == 1 ~ \"chocolate\",\n      TRUE ~ \"vanilla\"\n    ),\n    observed_outcome = case_when(\n      exposure == \"chocolate\" ~ y_chocolate,\n      exposure == \"vanilla\" ~ y_vanilla\n    )\n  ) |>\n  # we can only observe the exposure and one potential outcome\n  select(id, exposure, observed_outcome)\ndata_observed |>\n  group_by(exposure) |>\n  summarise(avg_outcome = mean(observed_outcome))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 2\n  exposure  avg_outcome\n  <chr>           <dbl>\n1 chocolate        5.33\n2 vanilla          4.71\n```\n\n\n:::\n:::\n\n\n## Causal Assumptions {#sec-assump}\n\nLike most statistical approaches, the validity of a causal analysis depends on how well certain assumptions are met.\nAs mentioned in @sec-potential, the potential outcomes framework envisions that each individual possesses a range of potential outcomes for every conceivable value of some input.\nFor instance, as in the scenario previously described with two exposure levels (exposed: 1 and unexposed: 0), we can define potential outcomes for exposure ($Y(1)$) and no exposure ($Y(0)$), and subsequently analyze the difference between these outcomes, i.e., $Y(1) - Y(0)$, to comprehend the impact of the input (the exposure) on the outcome, $Y$.\nAt any given time, only one of these *potential outcomes* is observable -- namely, the outcome tied to the actual exposure the individual underwent.\nUnder certain assumptions, we can leverage data from individuals exposed to different inputs to compare the average differences in their observed outcomes.\nThe most common assumptions across the approaches we describe in this book are:\n\n1.  **Consistency**: We assume that the causal question you claim you are answering is consistent with the one you are *actually* answering with your analysis. Mathematically, this means that $Y_{obs} = (X)Y(1) + (1 - X)Y(0)$, in other words, the outcome you observe is exactly equal to the potential outcome under the exposure you received.\n\n2.  **Well defined exposure**: We assume that for each value of the exposure, there is no difference between subjects in the delivery of that exposure.\nPut another way, multiple versions of the treatment do not exist. \n\n3.  **No interference**: We assume that the outcome (technically all *potential* outcomes, regardless of whether they are observed) for any subject does not depend on another subject's exposure.\n\n4.  **Exchangeability**: We assume that within levels of relevant variables (confounders), exposed and unexposed subjects have an equal likelihood of experiencing any outcome prior to exposure; i.e. the exposed and unexposed subjects are exchangeable.\nThis assumption is sometimes referred to as **no unmeasured confounding**.\n\n5.  **Positivity**: We assume that within each level and combination of the study variables used to achieve exchangeability, there are exposed and unexposed subjects.\nSaid differently, each individual has some chance of experiencing every available exposure level.\nSometimes this is referred to as the **probabilistic** assumption.\n\n::: callout-tip\n## Jargon\n\nAssumptions 1 through 3 are sometimes referred to as *stable-unit-treatment-value-assumption* or SUTVA [@imbens2015causal].\nLikewise, assumptions 1, 4, and 5 are referred to as *identifiability conditions* since we need them to hold in order to identify causal estimates.\nTechnically, assumption 2 (well defined exposure) is part of assumption 1 (consistency), but we find it useful in practice to check the concerns separately.\n:::\n\n### Causal Assumptions Simulation\n\nLet's bring back our simulation from @sec-po-sim. Recall that we have individuals who will either eat chocolate or vanilla ice cream and we are interested in assessing the causal effect of this exposure on their happiness. Let's see how violations of each assumption may impact the estimation of the causal effect.\n\n#### Consistency violation\n\nSuppose although we want to answer a causal question about the impact of chocolate versus vanilla ice cream, what we *actually* have is data on participants who had a choice of vanilla or cookies and cream. What we actually want to the average effect of `y_chocolate - y_vanilla`, but what we are *observing* is an estimate of `y_cookiesandcreme - y_vanilla`. Let's see how this could impact our result.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- data.frame(\n  id = 1:10,\n  y_cookiesandcreme = c(3, 3, 3, 2, 2, 3, 3, 4, 2, 3),\n  y_chocolate = c(4, 4, 6, 5, 6, 5, 6, 7, 5, 6),\n  y_vanilla = c(1, 3, 4, 5, 5, 6, 8, 6, 3, 5)\n) |>\n  mutate(causal_effect = y_chocolate - y_vanilla)\n\nset.seed(11)\ndata_observed <- data |>\n  mutate(\n    exposure = case_when(\n      rbinom(10, 1, 0.5) == 1 ~ \"chocolate (but actually cookies and creme)\",\n      TRUE ~ \"vanilla\"\n    ),\n    observed_outcome = case_when(\n      exposure == \"chocolate (but actually cookies and creme)\" ~ y_cookiesandcreme,\n      exposure == \"vanilla\" ~ y_vanilla\n    )\n  ) |>\n  select(id, exposure, observed_outcome)\n\ndata_observed |>\n  group_by(exposure) |>\n  summarise(avg_outcome = mean(observed_outcome))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 2\n  exposure                                  avg_outcome\n  <chr>                                           <dbl>\n1 chocolate (but actually cookies and crem…        2.67\n2 vanilla                                          4.71\n```\n\n\n:::\n:::\n\n\nWe know the *true* average causal effect in the sample is 0.8, however our estimated causal effect (because our data are not consistent with the question we are asking) is -2. This demonstrates what can go wrong when *consistency* is violated.\n\n#### Well defined exposure violation\n\nAs we mentioned, the \"well defined exposure\" assumption really falls under \"consistency\", but we think it can be helpful to be sure to explicitly think through what we mean by \"no multiple versions of treatment\". For example, suppose that there were in fact two containers of chocolate ice cream, one of which was spoiled. Therefore, despite the fact that having an exposure \"chocolate\" could mean different things depending on where the individual's scoop came from (regular chocolate ice cream, or spoiled chocolate ice cream), we are lumping them all together under a single umbrella (hence the violation, we have \"multiple versions of treatment\"). You can see how this falls under consistency because the issue here is that the potential outcome we think we are estimating is not the one we are actually observing.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- data.frame(\n  id = 1:10,\n  y_spoiledchocolate = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0),\n  y_chocolate = c(4, 4, 6, 5, 6, 5, 6, 7, 5, 6),\n  y_vanilla = c(1, 3, 4, 5, 5, 6, 8, 6, 3, 5)\n) |>\n  mutate(causal_effect = y_chocolate - y_vanilla)\n\nset.seed(11)\ndata_observed <- data |>\n  mutate(\n    exposure_unobserved = case_when(\n      rbinom(10, 1, 0.25) == 1 ~ \"chocolate (spoiled)\",\n      rbinom(10, 1, 0.25) == 1 ~ \"chocolate\",\n      TRUE ~ \"vanilla\"\n    ),\n    observed_outcome = case_when(\n      exposure_unobserved == \"chocolate (spoiled)\" ~ y_spoiledchocolate,\n      exposure_unobserved == \"chocolate\" ~ y_chocolate,\n      exposure_unobserved == \"vanilla\" ~ y_vanilla\n    ),\n    exposure = case_when(\n      exposure_unobserved %in% c(\"chocolate (spoiled)\", \"chocolate\") ~ \"chocolate\",\n      exposure_unobserved == \"vanilla\" ~ \"vanilla\"\n    )\n  ) |>\n  select(id, exposure, observed_outcome)\n\ndata_observed |>\n  group_by(exposure) |>\n  summarise(avg_outcome = mean(observed_outcome))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 2\n  exposure  avg_outcome\n  <chr>           <dbl>\n1 chocolate        2.75\n2 vanilla          4.67\n```\n\n\n:::\n:::\n\n\nAgain, we know the *true* average causal effect of (unspoiled) chocolate in the sample is 0.8, however our estimated causal effect (because our data are not consistent with the question we are asking) is -1.9. This demonstrates what can go wrong when *well defined exposure* is violated.\n\n#### Interference violation\n\nInterference would mean that an individual's exposure does not impact another's potential outcome. For example, let's say each individual has a partner, and their potential outcome depends on both what flavor of ice cream they ate *and* what flavor their partner ate. For example, in the simulation below, having a partner that received a different flavor of ice cream increases the happiness by two units.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- data.frame(\n  id = 1:10,\n  partner_id = c(1, 1, 2, 2, 3, 3, 4, 4, 5, 5),\n  y_chocolate_chocolate = c(4, 4, 6, 5, 6, 5, 6, 7, 5, 6),\n  y_chocolate_vanilla = c(6, 6, 8, 7, 8, 7, 8, 9, 7, 8),\n  y_vanilla_chocolate = c(3, 5, 6, 7, 7, 8, 10, 8, 5, 7),\n  y_vanilla_vanilla = c(1, 3, 4, 5, 5, 6, 8, 6, 3, 5)\n)\n\nset.seed(11)\ndata_observed <- data |>\n  mutate(\n    exposure = case_when(\n      rbinom(10, 1, 0.5) == 1 ~ \"chocolate\",\n      TRUE ~ \"vanilla\"\n    ),\n    exposure_partner =\n      c(\"vanilla\", \"vanilla\", \"vanilla\", \"chocolate\", \"chocolate\", \"vanilla\", \"vanilla\", \"vanilla\", \"vanilla\", \"chocolate\"),\n    observed_outcome = case_when(\n      exposure == \"chocolate\" & exposure_partner == \"chocolate\" ~ y_chocolate_chocolate,\n      exposure == \"chocolate\" & exposure_partner == \"vanilla\" ~ y_chocolate_vanilla,\n      exposure == \"vanilla\" & exposure_partner == \"chocolate\" ~ y_vanilla_chocolate,\n      exposure == \"vanilla\" & exposure_partner == \"vanilla\" ~ y_vanilla_vanilla\n    )\n  ) |>\n  select(id, exposure, observed_outcome)\n\ndata_observed |>\n  group_by(exposure) |>\n  summarise(avg_outcome = mean(observed_outcome))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 2\n  exposure  avg_outcome\n  <chr>           <dbl>\n1 chocolate        7.33\n2 vanilla          5.57\n```\n\n\n:::\n:::\n\nNow our estimated causal effect (because interference exists) is 1.8. This demonstrates what can go wrong when *interference* occurs. One of the main ways to combat interference is change the *unit* under consideration. Here, each individual, each unique *id*, is considered a unit, and there is interference between units (i.e. between partners). If instead we consider each *partner* as a unit and randomize the partners rather than the individuals, we solve the interference issue, as there is not interference *between* different partner sets. This is sometimes referred to as a *cluster randomized trial*. What we decide to do within each cluster may depend on the causal question at hand. For example, if we want to know what would happen if *everyone* at chocolate ice cream versus if *everyone* at vanilla, we would want to randomize both partners to either chocolate or vanilla, as seen below.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(11)\n\n## we are now randomizing the *partners* not the individuals\npartners <- data.frame(\n  partner_id = 1:5,\n  exposure = case_when(\n      rbinom(5, 1, 0.5) == 1 ~ \"chocolate\",\n      TRUE ~ \"vanilla\"\n    )\n)\ndata_observed <- data |>\n  left_join(partners, by = \"partner_id\") |>\n  mutate(\n    # all partners have the same exposure\n    exposure_partner = exposure,\n    observed_outcome = case_when(\n      exposure == \"chocolate\" & exposure_partner == \"chocolate\" ~ y_chocolate_chocolate,\n      exposure == \"vanilla\" & exposure_partner == \"vanilla\" ~ y_vanilla_vanilla\n    )\n  ) |>\n  select(id, exposure, observed_outcome)\n\ndata_observed |>\n  group_by(exposure) |>\n  summarise(avg_outcome = mean(observed_outcome))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 2\n  exposure  avg_outcome\n  <chr>           <dbl>\n1 chocolate        5.5 \n2 vanilla          4.38\n```\n\n\n:::\n:::\n\n\n#### Exchangeability violation\n\nWe have actually already seen an example of an exchangeability violation in @sec-po-sim. In that example, participants were able to choose the ice cream that they wanted to eat, so people who were more likely to have a positive effect from eating chocolate chose that, and those more likely to have a positive effect from eating vanilla chose that. \n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- data.frame(\n  id = 1:10,\n  y_chocolate = c(4, 4, 6, 5, 6, 5, 6, 7, 5, 6),\n  y_vanilla = c(1, 3, 4, 5, 5, 6, 8, 6, 3, 5)\n) \ndata_observed <- data |>\n  mutate(\n    exposure = case_when(\n      # people who like chocolate more chose that\n      y_chocolate > y_vanilla ~ \"chocolate\",\n      # people who like vanilla more chose that\n      y_vanilla >= y_chocolate ~ \"vanilla\"\n    ),\n    observed_outcome = case_when(\n      exposure == \"chocolate\" ~ y_chocolate,\n      exposure == \"vanilla\" ~ y_vanilla\n    )\n  ) |>\n  select(id, exposure, observed_outcome)\n\ndata_observed |>\n  group_by(exposure) |>\n  summarise(avg_outcome = mean(observed_outcome))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 2\n  exposure  avg_outcome\n  <chr>           <dbl>\n1 chocolate        5.43\n2 vanilla          6.33\n```\n\n\n:::\n:::\n\n\nHow could we correct this? If we had some people who preferred chocolate ice cream but ended up taking vanilla instead, we could *adjust* for the preference, and the effect conditioned on this would no longer have an exchangeability issue. It turns out that this example as we have constructed it doesn't lend itself to this solution because participants chose their preferred flavor 100% of the time making this *also* a positivity violation. \n\n#### Positivity violation\n\nAs stated above, the previous example violates both *exchangeability* and *positivity*. How could we fix it? As long as *some* people chose outside their preference with some probability (even if it is small!) we can remove this violation. Let's say instead of everyone picking their flavor of preference 100% of the time, they just had a 80% chance of picking that flavor.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- data.frame(\n  id = 1:10,\n  y_chocolate = c(4, 4, 6, 5, 6, 5, 6, 7, 5, 6),\n  y_vanilla = c(1, 3, 4, 5, 5, 6, 8, 6, 3, 5)\n) \n\nset.seed(11)\ndata_observed <- data |>\n  mutate(\n    prefer_chocolate = y_chocolate > y_vanilla ,\n    exposure = case_when(\n      # people who like chocolate more chose that 80% of the time\n      prefer_chocolate ~ ifelse(rbinom(10, 1, 0.8), \"chocolate\", \"vanilla\"),\n      # people who like vanilla more chose that 80% of the time\n      !prefer_chocolate ~ ifelse(rbinom(10, 1, 0.8), \"vanilla\", \"chocolate\")\n    ),\n    observed_outcome = case_when(\n      exposure == \"chocolate\" ~ y_chocolate,\n      exposure == \"vanilla\" ~ y_vanilla\n    )\n  ) |>\n  select(id, prefer_chocolate, exposure, observed_outcome)\n\nlm(observed_outcome ~ I(exposure == \"chocolate\") + prefer_chocolate, \n   data_observed)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = observed_outcome ~ I(exposure == \"chocolate\") + \n    prefer_chocolate, data = data_observed)\n\nCoefficients:\n                   (Intercept)  \n                         6.156  \nI(exposure == \"chocolate\")TRUE  \n                         0.531  \n          prefer_chocolateTRUE  \n                        -1.469  \n```\n\n\n:::\n:::\n\nAfter *adjusting* for this variable (chocolate preference), we recover the correct causal effect. This value is not exactly the same as the truth we obtain with the (unobservable) potential outcomes because we are dealing with a small sample -- as our sample size increases this will get closer to the truth.\n\nCausal assumptions can be difficult to verify and may not hold for many data collection strategies.\nWe cannot overstate the importance of checking these criteria to the extent possible!\nFollowing any of the recipes in this book are unlikely to give valid answers if the causal assumptions are badly violated.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../site_libs/kePrint/kePrint.js\"></script>\n<link href=\"../site_libs/lightable/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}